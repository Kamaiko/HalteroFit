name: CI

on:
  push:
    branches: [master]

# Cancel in-progress runs when a new commit is pushed to the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Default permissions (read-only)
permissions:
  contents: read

jobs:
  # ============================================================================
  # Job 1: Lint (TypeScript + ESLint + Prettier)
  # ============================================================================
  code-quality:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # TypeScript Incremental Build Cache
      # .tsbuildinfo enables faster subsequent type-checks
      - name: Cache TypeScript build info
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: .tsbuildinfo
          key: ${{ runner.os }}-tsbuildinfo-${{ hashFiles('**/tsconfig.json', 'src/**/*.ts', 'src/**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-tsbuildinfo-

      # ESLint Cache for faster linting
      - name: Cache ESLint
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: .eslintcache
          key: ${{ runner.os }}-eslintcache-${{ hashFiles('eslint.config.js', 'src/**/*.ts', 'src/**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-eslintcache-

      - name: TypeScript type-check
        run: npm run type-check

      - name: ESLint
        run: npm run lint:check

      - name: Prettier format check
        run: npm run format:check

      - name: Security audit
        # Only fail on CRITICAL vulnerabilities
        # Rationale: glob (HIGH) is CLI-only, doesn't affect React Native runtime
        run: npm audit --audit-level=critical

  # ============================================================================
  # Job 2: Expo SDK Compatibility
  # ============================================================================
  expo-doctor:
    name: Expo Doctor
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Expo SDK compatibility
        run: npx expo-doctor

  # ============================================================================
  # Job 3: Test (Jest with Coverage)
  # ============================================================================
  unit-tests:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Jest Cache for faster test runs
      - name: Cache Jest
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: .jest-cache
          key: ${{ runner.os }}-jest-${{ hashFiles('**/jest.config.js', 'src/**/*.test.ts', 'src/**/*.test.tsx') }}
          restore-keys: |
            ${{ runner.os }}-jest-

      - name: Run tests with coverage
        run: npm run test:ci

      # Coverage threshold check - see docs/TESTING.md for implementation timeline
      # - name: Check coverage threshold
      #   run: |
      #     node -e "
      #     const coverage = require('./coverage/coverage-summary.json');
      #     const lines = coverage.total.lines.pct;
      #     if (lines < 40) {
      #       console.error(\`Coverage ${lines}% is below 40% threshold\`);
      #       process.exit(1);
      #     }
      #     console.log(\`Coverage: ${lines}% âœ…\`);
      #     "

      - name: Upload coverage reports
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.6.0
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # ============================================================================
  # Job 4: Secrets (TruffleHog)
  # ============================================================================
  secrets-scan:
    name: Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 10 # Recent commits sufficient, scan runs on every push

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@6961f2bace57ab32b23b3ba40f8f420f6bc7e004 # v3.93.3
        with:
          extra_args: --only-verified
