name: Auto-Merge Monitor

# Monitor Dependabot PRs with auto-merge enabled but not merging
# Runs daily at 8AM EST to check for stale auto-merge PRs (open > 24h)

on:
  schedule:
    - cron: '0 13 * * *'  # Daily 8AM EST (13:00 UTC)
  workflow_dispatch:      # Manual trigger only

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-stale-auto-merge:
    name: Check Stale Auto-Merge PRs
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check for stale auto-merge PRs
        id: check
        run: |
          echo "Checking for PRs with auto-merge enabled > 24h..."

          STALE_PRS=$(gh pr list \
            --repo "$GITHUB_REPOSITORY" \
            --state open \
            --json number,title,autoMergeRequest,createdAt,url \
            --jq '[.[] | select(.autoMergeRequest != null) | select((now - (.createdAt | fromdateiso8601)) > 86400)]')

          if [ "$STALE_PRS" = "[]" ] || [ -z "$STALE_PRS" ]; then
            echo "No stale auto-merge PRs found"
            echo "has_stale=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found stale auto-merge PRs"
          echo "$STALE_PRS" > stale_prs.json
          echo "has_stale=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or update issue for stale PRs
        if: steps.check.outputs.has_stale == 'true'
        run: |
          STALE_PRS=$(cat stale_prs.json)

          # Check for existing open issue
          EXISTING_ISSUE=$(gh issue list \
            --repo "$GITHUB_REPOSITORY" \
            --label "ci,dependencies,needs-investigation" \
            --search "Auto-Merge Monitor" \
            --state open \
            --json number \
            --jq '.[0].number' || echo "")

          ISSUE_BODY=$(cat <<'EOFISSUE'
          ## Auto-Merge Monitoring Alert

          Detected PRs with auto-merge enabled for more than 24 hours.

          **Stale PRs:**
          STALE_PRS_PLACEHOLDER

          **Possible Causes:**
          - Branch protection blocking merge (PR behind base)
          - Failed required checks
          - Merge conflicts requiring manual resolution
          - GitHub API transient failures

          **Recommended Actions:**
          1. Check PR status and failed checks
          2. Run @dependabot rebase if PR is behind
          3. Manually merge if checks passing but auto-merge stuck
          4. Close and reopen PR if GitHub API issue suspected
          EOFISSUE
          )

          ISSUE_BODY="${ISSUE_BODY//STALE_PRS_PLACEHOLDER/$STALE_PRS}"

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Found existing issue #$EXISTING_ISSUE, adding comment instead of creating new issue"
            gh issue comment "$EXISTING_ISSUE" \
              --repo "$GITHUB_REPOSITORY" \
              --body "ðŸ”„ **Still Detecting Stale PRs** ($(date '+%Y-%m-%d %H:%M UTC'))

          $ISSUE_BODY"
          else
            echo "No existing issue found, creating new one"
            gh issue create \
              --repo "$GITHUB_REPOSITORY" \
              --title "Auto-Merge Monitor: Stale PRs Detected" \
              --label "ci,dependencies,needs-investigation" \
              --body "$ISSUE_BODY"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on stale PRs
        if: steps.check.outputs.has_stale == 'true'
        run: |
          cat stale_prs.json | jq -r '.[].number' | while read PR_NUM; do
            gh pr comment "$PR_NUM" \
              --repo "$GITHUB_REPOSITORY" \
              --body "Auto-Merge Monitor Alert: This PR has auto-merge enabled for more than 24h but has not merged. Please investigate."
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
