name: Auto-Merge Monitor

# ============================================================================
# Purpose: Monitor Dependabot PRs with auto-merge enabled but not merging
# ============================================================================
# Detects PRs where auto-merge is enabled but the PR has been open > 24 hours.
# This catches silent failures like:
# - Branch protection rules blocking merge
# - Failed checks not retrying
# - GitHub API issues
# - Merge conflicts
#
# Runs daily at 8AM EST (13:00 UTC) to check stale auto-merge PRs.
# ============================================================================

on:
  schedule:
    - cron: '0 13 * * *'  # Daily 8AM EST (13:00 UTC)
  workflow_dispatch:      # Manual trigger for testing

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-stale-auto-merge:
    name: Check Stale Auto-Merge PRs
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check for stale auto-merge PRs
        id: check
        run: |
          echo "ðŸ” Checking for PRs with auto-merge enabled > 24h..."

          # Get all open PRs with auto-merge enabled
          STALE_PRS=$(gh pr list \
            --repo "$GITHUB_REPOSITORY" \
            --state open \
            --json number,title,autoMergeRequest,createdAt,url \
            --jq '.[] | select(.autoMergeRequest != null) |
                   select(
                     (now - (.createdAt | fromdateiso8601)) > 86400
                   ) |
                   {number, title, age_hours: ((now - (.createdAt | fromdateiso8601)) / 3600 | floor), url}')

          if [ -z "$STALE_PRS" ]; then
            echo "âœ… No stale auto-merge PRs found"
            echo "has_stale=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âš ï¸  Found stale auto-merge PRs:"
          echo "$STALE_PRS"

          # Save for next step
          echo "$STALE_PRS" > stale_prs.json
          echo "has_stale=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create issue for stale PRs
        if: steps.check.outputs.has_stale == 'true'
        run: |
          # Read stale PRs
          STALE_PRS=$(cat stale_prs.json)

          # Build issue body
          ISSUE_BODY="## âš ï¸ Auto-Merge Monitoring Alert

**Detected PRs with auto-merge enabled but not merging for > 24 hours:**

\`\`\`json
$STALE_PRS
\`\`\`

### Possible Causes:
1. **Branch protection blocking merge** - PR might be behind base branch
2. **Failed checks** - One or more required checks might be failing
3. **Merge conflicts** - Manual resolution needed
4. **GitHub API issues** - Transient failures

### Recommended Actions:
1. Check each PR's status and failed checks
2. Run \`@dependabot rebase\` if PR is behind
3. Manually merge if checks are passing but auto-merge stuck
4. Close and reopen PR if GitHub API issue suspected

---
*This issue was automatically created by the Auto-Merge Monitor workflow.*
*See: \`.github/workflows/auto-merge-monitor.yml\`*"

          # Create issue
          gh issue create \
            --repo "$GITHUB_REPOSITORY" \
            --title "ðŸš¨ Auto-Merge Monitor: Stale PRs Detected" \
            --body "$ISSUE_BODY" \
            --label "ci,dependencies,needs-investigation"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on stale PRs
        if: steps.check.outputs.has_stale == 'true'
        run: |
          # Read stale PRs and comment on each
          STALE_PRS=$(cat stale_prs.json)

          echo "$STALE_PRS" | jq -r '.number' | while read PR_NUM; do
            gh pr comment "$PR_NUM" \
              --repo "$GITHUB_REPOSITORY" \
              --body "âš ï¸ **Auto-Merge Monitor Alert**

This PR has had auto-merge enabled for > 24 hours but hasn't merged yet.

**Possible issues:**
- Branch might be behind base (run \`@dependabot rebase\`)
- Required checks might be failing
- Merge conflicts need manual resolution

Please investigate and resolve. See the [Auto-Merge Monitor issue](https://github.com/$GITHUB_REPOSITORY/issues) for details."
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
